## **1. Проектирование межпользовательского перевода с использованием Саги**

### **Шаги Саги для перевода средств**

1. **Инициация перевода**

    - Пользователь А инициирует перевод суммы **S** на счет пользователя B.
    - Создается запись транзакции с уникальным идентификатором и статусом "В процессе".

2. **Списание средств со счета отправителя (Пользователь А)**

    - Проверяем, что баланс счета А ≥ **S**.
    - Проверяем, что после списания баланс счета А не нарушит ограничения (баланс ≥ 0).
    - Списываем сумму **S** со счета А.
    - Обновляем баланс счетов пользователя А (учитывая ограничение 25_000_000 на все счета).

3. **Зачисление средств на счет получателя (Пользователь B)**

    - Проверяем, что после зачисления суммы **S** баланс счета B ≤ 10_000_000.
    - Проверяем, что суммарный баланс всех счетов пользователя B после зачисления ≤ 25_000_000.
    - Зачисляем сумму **S** на счет B.
    - Обновляем баланс счетов пользователя B.

4. **Завершение транзакции**

    - Обновляем статус транзакции на "Выполнена".
    - Предоставляем возможность пользователю проверить статус транзакции по ее идентификатору.

### **Компенсирующие действия**

- Если на любом этапе происходит ошибка, запускается компенсирующая транзакция для отмены уже выполненных действий.

    - Если ошибка произошла после Шага 2 (средства списаны со счета А), но не удалось зачислить на счет B, то выполняем компенсирующее действие:

        - **Компенсация Шага 2**: Зачисляем сумму **S** обратно на счет А.

- Обновляем статус транзакции на "Отменена".

## **2. Возможные аномалии и способы борьбы с ними**

### **Аномалия 1: Нарушение ограничений баланса**

- **Ситуация**: После списания средств со счета А при попытке зачисления на счет B обнаруживается, что баланс счета B превысит 10_000_000 или суммарный баланс всех счетов B превысит 25_000_000.

- **Решение**:

    - Запускаем компенсирующую транзакцию для возврата средств на счет А.
    - Обновляем статус транзакции на "Отменена" с указанием причины.

### **Аномалия 2: Сбой системы или сети во время транзакции**

- **Ситуация**: Система выходит из строя между шагами или происходит сбой сети.

- **Решение**:

    - Используем механизм **идемпотентности** для операций, чтобы повторное выполнение не приводило к ошибкам.
    - Храним состояние транзакции и ее шагов в надежном хранилище (например, в базе данных с поддержкой транзакций).
    - При восстановлении системы продолжаем выполнение с того шага, на котором произошел сбой, или выполняем компенсацию.

### **Аномалия 3: Долгое выполнение транзакции**

- **Ситуация**: Транзакция зависла из-за проблемы с внешним сервисом или длительного ожидания.

- **Решение**:

    - Устанавливаем **тайм-ауты** для каждого шага транзакции.
    - Если тайм-аут превышен, инициируем компенсацию уже выполненных шагов.
    - Обновляем статус транзакции на "Отменена" с указанием причины.

### **Аномалия 4: Одновременные противоречивые операции**

- **Ситуация**: Одновременное выполнение транзакций может привести к превышению ограничений баланса.

- **Решение**:

    - Используем механизмы **синхронизации** или **блокировки** на уровне счетов или пользователей.
    - Применяем **оптимистичные блокировки** с повтором транзакций в случае конфликтов.
    - Гарантируем, что проверки баланса и обновления выполняются атомарно.

## **3. Обработка статусов транзакций**

- **Статусы транзакций**:

    - **"Впроцессе"**: Транзакция еще не завершена.
    - **"Выполнена"**: Транзакция успешно завершена, средства переведены.
    - **"Отменена"**: Транзакция не выполнена, система вернулась в исходное состояние.
    - **"Ошибка"**: Произошла ошибка, требующая вмешательства администратора.

- Пользователь может запрашивать статус транзакции по уникальному идентификатору через API или интерфейс пользователя.

## **4. Дополнительные меры для обеспечения надежности**

### **Идемпотентность операций**

- Обеспечиваем, чтобы повторное выполнение операций (списание, зачисление, компенсация) не приводило к двойным изменениям баланса.
- Используем уникальные идентификаторы транзакций и проверяем их перед выполнением операций.

### **Журналирование и мониторинг**

- Все действия в рамках Саги журналируются для последующего аудита.
- Реализуем мониторинг транзакций для своевременного обнаружения и обработки проблем.

### **Тестирование компенсационных сценариев**

- Тщательно тестируем сценарии сбоев и компенсаций, чтобы убедиться в правильности работы системы в исключительных ситуациях.

## **5. Пример сценария с обработкой аномалии**

**Сценарий**:

- Пользователь А хочет перевести 8_000_000 руб. пользователю B.
- Баланс счета А: 9_000_000 руб.
- Баланс счета B: 9_000_000 руб.
- Суммарный баланс всех счетов пользователя B: 24_000_000 руб.

**Шаги выполнения**:

1. **Инициация перевода**: Создаем транзакцию с ID 12345, статус "В процессе".

2. **Списание средств со счета А**:

    - Баланс счета А после списания: 1_000_000 руб. (не нарушает ограничения).
    - Списываем 8_000_000 руб. со счета А.

3. **Зачисление средств на счет B**:

    - Проверяем баланс счета B после зачисления: 17_000_000 руб. (превышает ограничение 10_000_000 руб.).
    - Обнаруживаем нарушение ограничения.

4. **Компенсация**:

    - Запускаем компенсирующую транзакцию.
    - Возвращаем 8_000_000 руб. на счет А (баланс счета А снова 9_000_000 руб.).
    - Обновляем статус транзакции 12345 на "Отменена" с причиной "Превышен максимальный баланс счета получателя".

5. **Уведомление пользователя**:

    - Сообщаем пользователю А о невозможности выполнения перевода и причине.

## **6. Соответствие требованиям заказчика**

- **Требование 1**: Реализованы переводы между счетами разных пользователей с учетом ограничений.

- **Требование 2**: Паттерн Сага обеспечивает целостность данных — деньги не исчезают и не появляются из ниоткуда.

- **Требование 3**: Допускается задержка между списанием и зачислением, что соответствует асинхронной природе Саги.

- **Требование 4**: Предоставляется возможность проверить статус транзакции в любой момент времени.

- **Требование 5**: В случае невозможности выполнения транзакции система возвращается в исходное состояние за счет компенсирующих действий.

## **7. Заключение**

Используя паттерн Сага, мы обеспечиваем надежное и согласованное выполнение межпользовательских переводов с учетом всех бизнес-правил и ограничений. Обработка аномалий и использование компенсирующих транзакций гарантируют, что система всегда возвращается в консистентное состояние, а средства клиентов защищены от потери или необъяснимого увеличения.
